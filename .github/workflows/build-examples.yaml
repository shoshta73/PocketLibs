name: build-examples

on:
  push:
    paths:
      [
        "integration-example/**",
        "casting.hxx",
        "CMakeLists.txt",
        ".github/workflows/build-examples.yaml",
      ]
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler:
          - { cc: gcc-14, cxx: g++-14 }
          - { cc: clang-19, cxx: clang++-19 }

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install compiler
        run: |
          sudo apt-get update
          if [[ "${{ matrix.compiler.cc }}" == gcc-* ]]; then
            sudo apt-get install -y ${{ matrix.compiler.cc }} ${{ matrix.compiler.cxx }}
          elif [[ "${{ matrix.compiler.cc }}" == clang-* ]]; then
            wget https://apt.llvm.org/llvm.sh
            chmod +x llvm.sh
            sudo ./llvm.sh 19
          fi

      - name: Configure CMake
        env:
          CC: ${{ matrix.compiler.cc }}
          CXX: ${{ matrix.compiler.cxx }}
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Run example
        run: build/integration-example/casting/expr_eval

  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Run example
        run: build/integration-example/casting/expr_eval

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Configure CMake
        run: cmake -B build

      - name: Build
        run: cmake --build build --config Release

      - name: Run example
        run: build/integration-example/casting/Release/expr_eval.exe
